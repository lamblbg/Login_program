# 登录流程

## 小程序登录

通过向接口发送正确的请求，koa后端会将请求参数code 连同Appid和Appsecret向微信服务器发起换取用户信息的请求，然后你将会获得openid和session_key，openid就是微信用户id，session_key则是微信服务器给开发者服务器颁发的身份凭证，开发者可以用session_key请求微信服务器其他接口来获取一些其他信息，且session_key不应该泄露或者下发到小程序前端。

通过openid到mongodb数据库查找该用户（没有找到该用户则在数据库中新增该用户），获得其在数据库的唯一标识\_id，然后调用加密函数加密\_id来生成session。

这个时候我们已经获得该用户的信息、session和jscode2session(即open_id、session_key)，然后我们把它们存储到redis中（把用户信息也存进一份进去是为了降低以后数据库的访问频率，直接在redis中取得用户信息），对应的键为\_id，并设置过期时间。

最后只返回用户的信息和session。用户信息供小程序展示使用；以后小程序请求其他接口时，在请求头携带上一个键为x-session，值为session的请求头，后端解密该session，获得其中的_id，然后在redis中看看能否找到对应的信息，就可判断该用户是否已经登录了。

通过分析，可以知道，应该保持session和redis中对应的登录信息的过期时间的一致，这两者的过期时间皆可在后端找到相应的地方进行设置。后端会验证小程序传递过来的session是否过期，如果过期了那么redis中相应的登录信息也没必要存在了；另外，如果session没有过期，而是redis中的登录信息因为过期而被删除了，通过该session也无法在redis找到登录信息，那么也是无法完成登录的。

## 扫码登录

小程序扫描web网页上的二维码实现登录

1.生成二维码字符串

网页请求扫码登录接口，后端返回一个字符串，该字符串通过加密当前时间戳生成，然后将该字符串作为键名存储到redis中，对应的值先设置为{"iv": "0"}，因为我知道这个值后面一定是一个session，而session对象中一定有一个iv属性（我也想存一个空对象，但存不进去啊），然后就是这个键值对的过期时间，也就是二维码的过期时间，我这里设置了20秒过期，读者可以根据需要进行调整。

2.绑定session

根据调用者传递过来的二维码字符串和session，在redis中把session信息更新进去

3.轮询二维码字符串

根据调用者传递过来的二维码字符串，轮询redis中是否有对应的值，进而判断用户是否已经扫码登录。如果没有查询到对应的值，则在10秒内会一直轮询，超过这个时间（这个时间不一定等于二维码的过期时间）会返回信息让调用者重新调用轮询；如果查询到对应的值，则可以解密session获取\_id，然后到redis或者mongodb中查找用户信息然后返回给调用者。

可以到redis中查找用户信息是因为用户每次启动小程序我们都要求它登录来判断session是否过期，redis是否还有登录信息，用户能扫码说明它一定是登录了的，那么session就没有过期，redis也还有登录信息。

很明显，扫码登录没有返回session，redis中也没有存储对应的登录状态，所以下一次登录仍需重新扫码。